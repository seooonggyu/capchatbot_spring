<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #222; height: 100vh; display: flex; flex-direction: column; }

        /* ìƒë‹¨ í—¤ë” */
        .viewer-header {
            height: 60px; background-color: #333; color: white; display: flex;
            justify-content: space-between; align-items: center; padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 10;
        }
        .file-title { font-size: 18px; font-weight: bold; }
        .btn-download {
            background-color: #4e73df; color: white; border: none; padding: 8px 15px;
            border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 14px;
        }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .viewer-body { flex: 1; display: flex; justify-content: center; align-items: center; overflow: auto; padding: 20px; }

        /* ì´ë¯¸ì§€: í™”ë©´ ë§ì¶¤ */
        img.content { max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* PDF: ì „ì²´ í™”ë©´ */
        iframe.content { width: 90%; height: 100%; border: none; background: white; }

        /* í…ìŠ¤íŠ¸ ë°•ìŠ¤ */
        .text-box {
            background: white; padding: 40px; width: 80%; max-width: 800px; height: 80%;
            overflow: auto; font-family: 'Consolas', monospace; white-space: pre-wrap;
            line-height: 1.6; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
            color: #333;
        }
    </style>
</head>
<body>

<div class="viewer-header">
    <div id="file_name" class="file-title">ë¡œë”© ì¤‘...</div>
    <button id="download_btn" class="btn-download">ë‹¤ìš´ë¡œë“œ</button> </div>

<div class="viewer-body" id="content_area">
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const fileId = urlParams.get('id');

    // ì „ì—­ ë³€ìˆ˜ë¡œ blobUrl ê´€ë¦¬ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ìš©)
    let currentBlobUrl = null;

    $(document).ready(function(){
        if(!fileId) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); window.close(); return; }
        loadFile();
    });

    // [í•µì‹¬] ì¸ì¦ í† í°ì„ í—¤ë”ì— ë‹´ì•„ íŒŒì¼ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function loadFile(){
        const viewUrl = `/api/file/${fileId}?mode=view`;

        let accessToken = localStorage.getItem("accessToken");
        let headers = {};
        if(accessToken) {
            if (!accessToken.startsWith("Bearer ")) accessToken = "Bearer " + accessToken;
            headers["Authorization"] = accessToken;
        }

        // fetchë¥¼ ì‚¬ìš©í•´ í—¤ë”ì™€ í•¨ê»˜ ìš”ì²­
        fetch(viewUrl, { method: 'GET', headers: headers })
            .then(response => {
                if(!response.ok) throw new Error("íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");

                // íŒŒì¼ëª… ì¶”ì¶œ
                const disposition = response.headers.get('Content-Disposition');
                let filename = "íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°";
                if (disposition && disposition.indexOf('filename=') !== -1) {
                    filename = decodeURIComponent(disposition.split('filename=')[1].replace(/"/g, ''));
                }
                $("#file_name").text(filename);

                // Content-Type ì¶”ì¶œ
                const contentType = response.headers.get('Content-Type');

                // ë°ì´í„°ë¥¼ Blob(íŒŒì¼ ê°ì²´)ìœ¼ë¡œ ë³€í™˜
                return response.blob().then(blob => {
                    return { blob, contentType, filename };
                });
            })
            .then(({ blob, contentType, filename }) => {
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ê¸°ëŠ¥ ì—°ê²°
                setupDownloadButton(blob, filename);

                // í™”ë©´ì— ê·¸ë¦¬ê¸°
                renderContent(blob, contentType, filename);
            })
            .catch(err => {
                console.error(err);
                $("#file_name").text("íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                if(err.message.includes("403") || err.message.includes("401")){
                    alert("ê¶Œí•œì´ ì—†ê±°ë‚˜ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.close();
                }
            });
    }

    // Blob ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function renderContent(blob, type, filename) {
        let area = $("#content_area");
        area.empty();

        // Blobì„ ê°€ë¦¬í‚¤ëŠ” ì„ì‹œ URL ìƒì„± (ì˜ˆ: blob:http://localhost/...)
        if(currentBlobUrl) URL.revokeObjectURL(currentBlobUrl); // ê¸°ì¡´ URL í•´ì œ
        currentBlobUrl = URL.createObjectURL(blob);

        let ext = filename.split('.').pop().toLowerCase();

        if (type.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext)) {
            // [ì´ë¯¸ì§€] srcì— blobUrlì„ ë„£ìœ¼ë©´ ì¸ì¦ ì—†ì´ë„ ë³´ì„ (ì´ë¯¸ ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ì— ìˆìœ¼ë‹ˆê¹Œ)
            area.html(`<img src="${currentBlobUrl}" class="content">`);

        } else if (type === 'application/pdf' || ext === 'pdf') {
            // [PDF] iframeì— blobUrl ì—°ê²°
            area.html(`<iframe src="${currentBlobUrl}" class="content"></iframe>`);

        } else if (type.startsWith('text/') || ['txt', 'md', 'json', 'xml', 'java', 'js'].includes(ext)) {
            // [í…ìŠ¤íŠ¸] Blobì„ í…ìŠ¤íŠ¸ë¡œ ì½ì–´ì„œ í‘œì‹œ
            blob.text().then(text => {
                area.html(`<div class="text-box">${escapeHtml(text)}</div>`);
            });

        } else {
            // [ê·¸ ì™¸]
            area.html(`
                <div style="color: #ccc; text-align: center;">
                    <p style="font-size: 50px;">ğŸ“</p>
                    <p>ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.</p>
                </div>
            `);
        }
    }

    // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì„¤ì • (a íƒœê·¸ í´ë¦­ ì‹œì—ë„ í—¤ë”ê°€ ì•ˆ ì‹¤ë¦¬ë¯€ë¡œ, Blobì„ ì´ìš©í•´ ë‹¤ìš´ë¡œë“œ)
    function setupDownloadButton(blob, filename) {
        $("#download_btn").off("click").on("click", function() {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename; // ë‹¤ìš´ë¡œë“œ íŒŒì¼ëª… ì§€ì •
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
    }

    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>

</body>
</html>