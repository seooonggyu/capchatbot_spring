<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íŒŒì¼ ê´€ë¦¬</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fc; padding: 40px; margin: 0; }

        /* --- ìƒë‹¨ í—¤ë” ì˜ì—­ --- */
        .header-area { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }

        .page-title { font-size: 24px; font-weight: bold; color: #5a5c69; }
        .btn-back { text-decoration: none; color: #858796; font-size: 14px; padding: 8px 16px; border: 1px solid #d1d3e2; border-radius: 4px; background: white; }
        .btn-back:hover { background-color: #eaecf4; }

        /* --- ë²„íŠ¼ ê·¸ë£¹ --- */
        .btn-group { display: flex; gap: 10px; }
        .btn-common {
            padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;
            border: 1px solid transparent; transition: all 0.2s;
        }
        /* íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ (íŒŒë€ìƒ‰) */
        .btn-upload { background-color: white; border-color: #4e73df; color: #4e73df; }
        .btn-upload:hover { background-color: #4e73df; color: white; }
        /* í´ë” ìƒì„± ë²„íŠ¼ (ë…¹ìƒ‰) */
        .btn-new-folder { background-color: white; border-color: #1cc88a; color: #1cc88a; }
        .btn-new-folder:hover { background-color: #1cc88a; color: white; }

        /* --- Breadcrumb (ê²½ë¡œ ë„¤ë¹„ê²Œì´ì…˜) --- */
        .breadcrumb-bar {
            background-color: #fff; padding: 10px 15px; border-radius: 4px; border: 1px solid #e3e6f0;
            display: flex; align-items: center; font-size: 14px; color: #858796;
        }
        .breadcrumb-item { cursor: pointer; color: #4e73df; font-weight: bold; padding: 2px 5px; border-radius: 4px; }
        .breadcrumb-item:hover { text-decoration: underline; background-color: #f1f1f1; }

        .breadcrumb-separator { margin: 0 5px; color: #aaa; }

        .breadcrumb-current { color: #555; font-weight: normal; cursor: default; padding: 2px 5px; border-radius: 4px; }


        /* --- ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ --- */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* ë°˜ì‘í˜• */
            gap: 20px;
        }

        /* --- ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼ (í´ë”/íŒŒì¼) --- */
        .item-card {
            background: white; border: 1px solid #e3e6f0; border-radius: 8px;
            height: 180px; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            user-select: none; /* ë“œë˜ê·¸ ì‹œ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
        }
        .item-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* â˜… ë“œë˜ê·¸ ì•¤ ë“œë¡­ íƒ€ê²Ÿ ê°•ì¡° ìŠ¤íƒ€ì¼ (ì¹´ë“œìš©) â˜… */
        .drag-over {
            border: 2px dashed #4e73df !important;
            background-color: #eef2ff !important;
            transform: scale(1.05);
            z-index: 5;
        }

        /* â˜… [ì¶”ê°€] ë“œë˜ê·¸ ì•¤ ë“œë¡­ íƒ€ê²Ÿ ê°•ì¡° ìŠ¤íƒ€ì¼ (Breadcrumb ê¸€ììš©) â˜… */
        /* ê¸€ì(span)ëŠ” í¬ê¸°ê°€ ì»¤ì§€ë©´(scale) ë ˆì´ì•„ì›ƒì´ ê¹¨ì§€ë¯€ë¡œ ì•„ì›ƒë¼ì¸ë§Œ í‘œì‹œ */
        span.drag-over {
            transform: none !important;
            border: none !important;
            outline: 2px dashed #4e73df;
            background-color: #eef2ff !important;
        }

        /* ì•„ì´ì½˜ ì˜ì—­ */
        .item-icon { font-size: 50px; margin-bottom: 10px; }

        /* í…ìŠ¤íŠ¸ ì˜ì—­ */
        .item-name { font-size: 14px; color: #333; padding: 0 10px; text-align: center; word-break: break-all; font-weight: 500; }
        .item-meta { font-size: 11px; color: #aaa; margin-top: 5px; }

        /* --- Hover Overlay (ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ë²„íŠ¼ë“¤) --- */
        .hover-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px;
            opacity: 0; transition: opacity 0.2s ease;
            z-index: 10; cursor: default;
        }
        .item-card:hover .hover-overlay { opacity: 1; }

        .btn-action {
            width: 90px; padding: 6px 0; border: none; border-radius: 20px;
            font-size: 12px; cursor: pointer; font-weight: bold; text-decoration: none;
            text-align: center; display: block; color: white;
        }
        /* ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-enter { background-color: #4e73df; } /* í´ë” ì§„ì… */
        .btn-view  { background-color: #36b9cc; } /* ë¯¸ë¦¬ë³´ê¸° */
        .btn-down  { background-color: #f6c23e; } /* ë‹¤ìš´ë¡œë“œ */
        .btn-del   { background-color: #e74a3b; } /* ì‚­ì œ */

        .btn-action:hover { opacity: 0.9; }

        /* ë¹ˆ í´ë” ì•ˆë‚´ */
        .empty-msg { grid-column: 1/-1; text-align: center; padding: 50px; color: #858796; }

    </style>
</head>
<body>

<div class="header-area">
    <div class="header-top">
        <div>
            <a href="/space/list" class="btn-back">â† ìŠ¤í˜ì´ìŠ¤ ëª©ë¡</a>
            <span class="page-title" style="margin-left: 15px;">ğŸ—‚ï¸ íŒŒì¼ íƒìƒ‰ê¸°</span>
        </div>

        <div class="btn-group">
            <button class="btn-common btn-new-folder" onclick="createNewFolder()">+ ìƒˆ í´ë”</button>
            <button class="btn-common btn-upload" onclick="$('#fileInput').click()">+ íŒŒì¼ ì—…ë¡œë“œ</button>
            <input type="file" id="fileInput" style="display: none;" onchange="uploadFile()">
        </div>
    </div>

    <div class="breadcrumb-bar" id="breadcrumb_area">
        <span class="breadcrumb-current">Home</span>
    </div>
</div>

<div id="file_list_area" class="file-grid">
</div>

<script>
    // URLì—ì„œ spaceId ì¶”ì¶œ (/space/fileList/10 -> 10)
    const pathParts = location.pathname.split('/');
    const spaceId = pathParts[pathParts.length - 1];

    // â˜… ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ â˜…
    let currentFolderId = null; // í˜„ì¬ ë³´ê³  ìˆëŠ” í´ë” ID (null = ìµœìƒìœ„ ë£¨íŠ¸)

    // ê²½ë¡œ ê´€ë¦¬ ìŠ¤íƒ (Breadcrumbìš©)
    let folderStack = [
        { id: null, name: 'Home' }
    ];

    $(document).ready(function(){
        // JWT í† í° ì„¤ì • (AJAX ìš”ì²­ ì‹œ í—¤ë”ì— ìë™ í¬í•¨)
        let accessToken = localStorage.getItem("accessToken");
        if(accessToken){
            $.ajaxSetup({
                beforeSend: function(xhr){
                    if (!accessToken.startsWith("Bearer ")) accessToken = "Bearer " + accessToken;
                    xhr.setRequestHeader("Authorization", accessToken);
                }
            });
        }

        // ì´ˆê¸° ë¡œë“œ
        loadItems();
        renderBreadcrumb();
    });

    // ==========================================
    // 1. ëª©ë¡ ì¡°íšŒ (í´ë” + íŒŒì¼) & ë Œë”ë§
    // ==========================================
    function loadItems(){
        $.ajax({
            url: '/api/file/list',
            method: 'GET',
            data: {
                spaceId: spaceId,
                folderId: currentFolderId
            },
            success: function(data){
                let area = $("#file_list_area");
                area.empty();

                if(!data || data.length === 0){
                    area.html("<div class='empty-msg'>í´ë”ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>");
                    return;
                }

                $.each(data, function(idx, item){
                    let html = "";

                    // â˜… ë“œë˜ê·¸ ê³µí†µ ì†ì„± ì„¤ì • (Start)
                    let dragAttr = `draggable="true" ondragstart="handleDragStart(event, ${item.id}, '${item.type}')"`;

                    // A. í´ë”ì¸ ê²½ìš°
                    if(item.type === 'FOLDER') {
                        // í´ë”ëŠ” 'ë°›ëŠ” ì—­í• (Drop Target)'ë„ ìˆ˜í–‰ (Drop, Over, Leave)
                        html = `
                            <div class="item-card" ${dragAttr}
                                 ondragover="handleDragOver(event)"
                                 ondragleave="handleDragLeave(event)"
                                 ondrop="handleDrop(event, ${item.id})">

                                <div class="item-icon">ğŸ“</div>
                                <div class="item-name">${item.name}</div>
                                <div class="item-meta">í´ë”</div>

                                <div class="hover-overlay">
                                    <button onclick="enterFolder(${item.id}, '${item.name}')" class="btn-action btn-enter">ì—´ê¸°</button>
                                    <button onclick="deleteFolder(${item.id})" class="btn-action btn-del">ì‚­ì œ</button>
                                </div>
                            </div>
                        `;
                    }
                    // B. íŒŒì¼ì¸ ê²½ìš°
                    else {
                        let sizeMB = (item.size / (1024 * 1024)).toFixed(2) + " MB";
                        html = `
                            <div class="item-card" ${dragAttr}>
                                <div class="item-icon">ğŸ“„</div>
                                <div class="item-name">${item.name}</div>
                                <div class="item-meta">${sizeMB}</div>
                                <div class="item-meta">by ${item.uploaderName}</div>

                                <div class="hover-overlay">
                                    <a href="/space/fileViewer?id=${item.id}" target="_blank" class="btn-action btn-view">ë¯¸ë¦¬ë³´ê¸°</a>
                                    <a href="/api/file/${item.id}?mode=download" class="btn-action btn-down">ë‹¤ìš´ë¡œë“œ</a>
                                    <button onclick="deleteFile(${item.id})" class="btn-action btn-del">ì‚­ì œ</button>
                                </div>
                            </div>
                        `;
                    }
                    area.append(html);
                });
            },
            error: function(err){
                alert("ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    // ==========================================
    // 2. í´ë” ë„¤ë¹„ê²Œì´ì…˜ & Breadcrumb
    // ==========================================

    // í´ë” ì•ˆìœ¼ë¡œ ì§„ì…
    function enterFolder(folderId, folderName) {
        currentFolderId = folderId;
        folderStack.push({ id: folderId, name: folderName });
        renderBreadcrumb();
        loadItems();
    }

    // Breadcrumb í´ë¦­ ì´ë™
    function goToFolder(index) {
        folderStack = folderStack.slice(0, index + 1);
        currentFolderId = folderStack[folderStack.length - 1].id;
        renderBreadcrumb();
        loadItems();
    }

    // â˜… Breadcrumb UI ë Œë”ë§ (ì—¬ê¸°ë„ ë“œë¡­ ì¡´ìœ¼ë¡œ ë§Œë“¦!)
    function renderBreadcrumb() {
        let bcArea = $("#breadcrumb_area");
        bcArea.empty();

        folderStack.forEach((folder, index) => {
            // folder.idê°€ nullì¸ ê²½ìš°(Root) JS í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ë¬¸ì œê°€ ì—†ë„ë¡ ì²˜ë¦¬
            let folderIdParam = (folder.id === null) ? 'null' : folder.id;

            // ë“œë¡­ ê´€ë ¨ ì´ë²¤íŠ¸ ì†ì„± ì •ì˜
            let dropAttr = `
                ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)"
                ondrop="handleDrop(event, ${folderIdParam})"
            `;

            if (index === folderStack.length - 1) {
                // í˜„ì¬ ìœ„ì¹˜ (ë§ˆì§€ë§‰) - ë“œë¡­ì€ ê°€ëŠ¥í•˜ì§€ë§Œ í´ë¦­ì€ ì•ˆ ë¨
                bcArea.append(`<span class="breadcrumb-current" ${dropAttr}>${folder.name}</span>`);
            } else {
                // ìƒìœ„ ê²½ë¡œ - í´ë¦­ ì´ë™ ê°€ëŠ¥ + ë“œë¡­ ê°€ëŠ¥
                bcArea.append(`
                    <span class="breadcrumb-item" onclick="goToFolder(${index})" ${dropAttr}>${folder.name}</span>
                    <span class="breadcrumb-separator">></span>
                `);
            }
        });
    }


    // ==========================================
    // 3. ìƒì„± ë° ì—…ë¡œë“œ (Create)
    // ==========================================

    // í´ë” ìƒì„±
    function createNewFolder() {
        let name = prompt("ìƒˆ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if(!name || name.trim() === "") return;

        let reqData = {
            spaceId: spaceId,
            parentId: currentFolderId,
            name: name.trim()
        };

        $.ajax({
            url: '/api/file/folder',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(reqData),
            success: function() { loadItems(); },
            error: function(err) { alert("í´ë” ìƒì„± ì‹¤íŒ¨: " + (err.responseText || "ì˜¤ë¥˜")); }
        });
    }

    // íŒŒì¼ ì—…ë¡œë“œ
    function uploadFile(){
        let fileInput = $("#fileInput")[0];
        if(fileInput.files.length === 0) return;

        let formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("spaceId", spaceId);

        if(currentFolderId != null) {
            formData.append("folderId", currentFolderId);
        }

        $.ajax({
            url: '/api/file',
            method: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(){
                alert("ì—…ë¡œë“œ ì™„ë£Œ!");
                loadItems();
                $("#fileInput").val("");
            },
            error: function(err){
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
                $("#fileInput").val("");
            }
        });
    }


    // ==========================================
    // 4. ì‚­ì œ (Delete)
    // ==========================================

    function deleteFile(fileId){
        if(!confirm("íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        $.ajax({
            url: '/api/file',
            method: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ id: fileId }),
            success: function(){ loadItems(); },
            error: function(){ alert("ì‚­ì œ ì‹¤íŒ¨"); }
        });
    }

    function deleteFolder(folderId){
        if(!confirm("í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë‚´ë¶€ íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)")) return;
        $.ajax({
            url: '/api/file/folder',
            method: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ id: folderId }),
            success: function(){ loadItems(); },
            error: function(){ alert("ì‚­ì œ ì‹¤íŒ¨"); }
        });
    }


    // ==========================================
    // 5. ë“œë˜ê·¸ ì•¤ ë“œë¡­ (Move) - í•µì‹¬ ê¸°ëŠ¥
    // ==========================================

    // [ë“œë˜ê·¸ ì‹œì‘]
    function handleDragStart(e, id, type) {
        // ì˜®ê¸¸ ì•„ì´í…œì˜ ì •ë³´ë¥¼ ë‹´ìŠµë‹ˆë‹¤.
        e.dataTransfer.setData("text/plain", JSON.stringify({ id: id, type: type }));
        e.dataTransfer.effectAllowed = "move";
    }

    // [ë“œë˜ê·¸ ì˜¤ë²„] íƒ€ê²Ÿ ìœ„ì— ì˜¬ë¼ì™”ì„ ë•Œ
    function handleDragOver(e) {
        e.preventDefault(); // ë“œë¡­ í—ˆìš©ì„ ìœ„í•´ í•„ìˆ˜
        e.dataTransfer.dropEffect = "move";
        // CSS í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•˜ì—¬ ì‹œê°ì ìœ¼ë¡œ ì•Œë ¤ì¤Œ (span, div ëª¨ë‘ ë™ì‘)
        $(e.currentTarget).addClass("drag-over");
    }

    // [ë“œë˜ê·¸ ë¦¬ë¸Œ] íƒ€ê²Ÿì—ì„œ ë²—ì–´ë‚¬ì„ ë•Œ
    function handleDragLeave(e) {
        $(e.currentTarget).removeClass("drag-over");
    }

    // [ë“œë¡­] ë†“ì•˜ì„ ë•Œ -> ì„œë²„ë¡œ ì´ë™ ìš”ì²­
    function handleDrop(e, targetFolderId) {
        e.preventDefault();
        $(e.currentTarget).removeClass("drag-over"); // íš¨ê³¼ ì œê±°

        let data = e.dataTransfer.getData("text/plain");
        if(!data) return;

        let draggedItem = JSON.parse(data);

        // ìê¸° ìì‹ ì—ê²Œ ë„£ëŠ” ê±´ ë¬´íš¨ (í´ë” -> ìê¸°ìì‹ )
        if(draggedItem.type === 'FOLDER' && draggedItem.id === targetFolderId) return;

        // í˜„ì¬ í´ë”ì™€ íƒ€ê²Ÿ í´ë”ê°€ ê°™ìœ¼ë©´ ë¬´íš¨ (ì´ë™í•˜ë‚˜ ë§ˆë‚˜)
        // (ë‹¨, Breadcrumbì„ í†µí•´ ìƒìœ„ë¡œ ì´ë™í•˜ëŠ” ê²½ìš°ëŠ” currentFolderIdì™€ targetFolderIdê°€ ë‹¤ë¦„)
        if(currentFolderId === targetFolderId) return;

        moveItem(draggedItem.id, draggedItem.type, targetFolderId);
    }

    // ì„œë²„ ì´ë™ API í˜¸ì¶œ
    function moveItem(id, type, targetFolderId) {
        $.ajax({
            url: '/api/file/move',
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                id: id,
                type: type,
                targetFolderId: targetFolderId // nullì´ë©´ ë£¨íŠ¸ë¡œ ì´ë™ë¨
            }),
            success: function() {
                loadItems(); // ì´ë™ í›„ í˜„ì¬ ëª©ë¡ ê°±ì‹ 
            },
            error: function(err) {
                alert("ì´ë™ ì‹¤íŒ¨: " + (err.responseText || "ì˜¤ë¥˜"));
            }
        });
    }

</script>

</body>
</html>