<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>그룹 관리</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/startbootstrap-sb-admin-2/4.1.4/css/sb-admin-2.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fc; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; }

        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: bold; color: #5a5c69; }

        /* [추가] 버튼 그룹 정렬을 위한 스타일 */
        .btn-group-area { display: flex; gap: 10px; }

        /* [추가] 업무 추가 버튼 (파란색 테두리) */
        .btn-add-work {
            background-color: white;
            border: 1px solid #4e73df;
            color: #4e73df;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-add-work:hover {
            background-color: #4e73df;
            color: white;
        }

        /* 기존 그룹 삭제 버튼 (붉은색 테두리) */
        .btn-delete-group {
            background-color: white;
            border: 1px solid #e74a3b;
            color: #e74a3b;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-delete-group:hover {
            background-color: #e74a3b;
            color: white;
        }

        .list-area { display: flex; flex-direction: column; gap: 15px; }
        .space-item {
            background: white; border: 1px solid #e3e6f0; border-radius: 5px;
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
        }

        .info-box div { margin-bottom: 3px; }
        .txt-title { font-size: 18px; font-weight: bold; color: #333; }
        .txt-sub { font-size: 14px; color: #888; }

        .btn-area { display: flex; gap: 10px; }
        .btn-enter { background-color: #858796; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-handover { background-color: #d1d3e2; color: #333; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="mb-3">
        <a href="/user/profile" class="btn btn-light btn-sm">← 내 프로필로</a>
    </div>

    <div class="header-area">
        <div class="page-title">스페이스 목록</div>

        <div class="btn-group-area">
            <button class="btn-add-work" onclick="addWork()">업무 추가</button>
            <button class="btn-delete-group" onclick="deleteGroup()">그룹 삭제</button>
        </div>
    </div>

    <div id="space_list_area" class="list-area">
    </div>
</div>

<script>
    // URL에서 groupId 추출 (/group/spaceList/10)
    const pathParts = location.pathname.split('/');
    const groupId = pathParts[pathParts.length - 1];

    $(document).ready(function(){
        let accessToken = localStorage.getItem("accessToken");
        if(accessToken){
            $.ajaxSetup({
                beforeSend: function(xhr){
                    if (!accessToken.startsWith("Bearer ")) accessToken = "Bearer " + accessToken;
                    xhr.setRequestHeader("Authorization", accessToken);
                }
            });
        }
        loadGroupSpaces();
    });

    // 1. 그룹 내 스페이스 목록 조회
    function loadGroupSpaces(){
        $.ajax({
            url: '/api/userSpace/list',
            method: 'GET',
            data: {
                groupId: groupId,  // 해당 그룹 ID
                deleted: false,
                role: "ADMIN"
            },
            success: function(data){
                let listArea = $("#space_list_area");
                listArea.empty();

                if(!data || data.length === 0){
                    listArea.html("<div class='text-center p-4'>스페이스가 없습니다.</div>");
                    return;
                }

                $.each(data, function(index, item){
                    let groupName = item.groupName || "그룹없음";
                    let workName = item.workName || "업무없음";
                    let spaceCode = item.spaceCode || "코드없음";
                    let createdAt = item.createdAt ? item.createdAt.split('T')[0] : "-";

                    let html = `
                        <div class="space-item">
                            <div class="info-box">
                                <div class="txt-title">${groupName} ${workName}</div>
                                <div class="txt-sub">${spaceCode}</div>
                                <div class="txt-sub">생성일: ${createdAt}</div>
                            </div>
                            <div class="btn-area">
                                <button class="btn-enter" onclick="location.href='/space/detail/${item.spaceId}'">입장</button>
                                <button class="btn-handover" onclick="requestHandover(${item.spaceId})">인계</button>
                            </div>
                        </div>
                    `;
                    listArea.append(html);
                });
            },
            error: function(){
                alert("목록을 불러오지 못했습니다.");
            }
        });
    }

    // [추가] 2. 업무 추가 기능
    function addWork() {
        // 1단계: 업무명 입력
        let workName = prompt("추가할 업무명을 입력하세요:");
        if (!workName || workName.trim() === "") return;

        // 2단계: 이메일 입력 (선택사항)
        let userEmail = prompt("담당자 이메일을 입력하세요 (선택):");

        let _data = {
            groupId: groupId,
            workName: workName.trim(),
            // ▼▼▼ 이메일 데이터 추가 (입력 안 했으면 빈 문자열)
            userEmail: userEmail ? userEmail.trim() : ""
        };

        $.ajax({
            url: '/api/space',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(_data),
            success: function() {
                alert("업무가 추가되었습니다.");
                loadGroupSpaces();
            },
            error: function(err) {
                let msg = "업무 추가에 실패했습니다.";
                if(err.responseJSON && err.responseJSON.message) msg = err.responseJSON.message;
                alert(msg);
            }
        });
    }

    // 3. 인계하기 기능
    function requestHandover(spaceId){
        let email = prompt("업무를 인계할 사용자의 이메일을 입력하세요:");
        if(!email) return;

        $.ajax({
            url: '/api/userSpace/invite',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ spaceId: spaceId, email: email.trim() }),
            success: function() { alert("인계(초대) 완료!"); },
            error: function(err) {
                let msg = err.responseJSON && err.responseJSON.message ? err.responseJSON.message : "실패했습니다.";
                alert(msg);
            }
        });
    }

    // 그룹 삭제 기능 구현
    function deleteGroup() {
        if (!confirm("정말 이 그룹을 삭제하시겠습니까?\n그룹에 포함된 모든 업무(스페이스)도 함께 삭제됩니다.")) {
            return;
        }

        let _data = {
            id: groupId // URL에서 추출한 전역 변수 사용
        };

        $.ajax({
            url: '/api/group', // GroupRestController의 delete 메서드 호출
            method: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify(_data),
            success: function() {
                alert("그룹과 소속된 모든 업무가 삭제되었습니다.");
                location.href = "/user/profile"; // 프로필로 이동
            },
            error: function(err) {
                alert("그룹 삭제에 실패했습니다.");
            }
        });
    }
</script>

</body>
</html>