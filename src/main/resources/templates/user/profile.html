<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ í”„ë¡œí•„</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/startbootstrap-sb-admin-2/4.1.4/css/sb-admin-2.min.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fc; padding: 40px; }
        .profile-wrapper { display: flex; gap: 40px; }

        /* ì™¼ìª½ í”„ë¡œí•„ ì¹´ë“œ */
        .profile-section {
            width: 300px; background: white; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 40px 20px;
            text-align: center; height: fit-content;
        }
        .profile-icon { font-size: 80px; color: #eaecf4; margin-bottom: 20px; }
        .profile-name { font-size: 22px; font-weight: bold; color: #5a5c69; margin-bottom: 5px; }
        .profile-email { font-size: 15px; color: #858796; margin-bottom: 30px; }

        /* [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-logout {
            background-color: white;
            border: 1px solid #e74a3b;
            color: #e74a3b;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            width: 80%;
            transition: all 0.2s;
        }
        .btn-logout:hover {
            background-color: #e74a3b;
            color: white;
        }

        /* ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        .list-section { flex: 1; }
        .section-header { font-size: 18px; font-weight: bold; color: #4e73df; margin-bottom: 15px; border-left: 4px solid #4e73df; padding-left: 10px; }

        .card-item {
            background: white; border: 1px solid #e3e6f0; border-radius: 5px;
            padding: 20px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .item-info strong { font-size: 18px; color: #333; }
        .item-info span { display: block; font-size: 14px; color: #888; margin-top: 4px; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-gray { background-color: #858796; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 14px; cursor: pointer; }
        .btn-yellow { background-color: #f6c23e; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 14px; cursor: pointer; }
        .btn-yellow:hover { background-color: #dfa528; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="mb-4">
        <a href="/space/list" class="btn btn-light btn-sm">â† ë‚´ ìŠ¤í˜ì´ìŠ¤ ëª©ë¡</a>
    </div>

    <div class="profile-wrapper">
        <div class="profile-section">
            <div class="profile-icon">ğŸ‘¤</div>
            <div id="text_name" class="profile-name">-</div>
            <div id="text_email" class="profile-email">-</div>

            <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="list-section">

            <div class="mb-5">
                <div class="section-header">ë‚´ ê·¸ë£¹ (ê´€ë¦¬ì)</div>
                <div id="admin_list_area">
                </div>
            </div>

            <div>
                <div class="section-header">ì°¸ì—¬ ì¤‘ì¸ ì—…ë¬´ (ì‚¬ìš©ì)</div>
                <div id="user_list_area">
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        // 1. í† í° í—¤ë” ì„¤ì •
        let accessToken = localStorage.getItem("accessToken");
        if(accessToken){
            $.ajaxSetup({
                beforeSend: function(xhr){
                    if (!accessToken.startsWith("Bearer ")) accessToken = "Bearer " + accessToken;
                    xhr.setRequestHeader("Authorization", accessToken);
                }
            });
        }

        // 2. ë°ì´í„° ë¡œë“œ
        loadMyProfile();
        loadMySpaces();
    });

    // ë‚´ ì •ë³´(ì´ë¦„, ì´ë©”ì¼) ë¶ˆëŸ¬ì˜¤ê¸°
    function loadMyProfile(){
        $.ajax({
            url: '/api/user',
            method: 'GET',
            data: { deleted: false },
            success: function(data){
                let name = data.name ? data.name : data.username;
                let email = data.email ? data.email : "";
                $("#text_name").text(name);
                $("#text_email").text(email);
            },
            error: function(){
                // í† í° ë§Œë£Œ ë“±ì˜ ì´ìœ ë¡œ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
                // location.href = "/user/login";
            }
        });
    }

    // ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì™€ì„œ ADMIN(ê·¸ë£¹í•‘), USER(ë‚˜ì—´) ë¶„ë¦¬
    function loadMySpaces(){
        $.ajax({
            url: '/api/userSpace/list',
            method: 'GET',
            data: { deleted: false },
            success: function(data){
                let adminArea = $("#admin_list_area");
                let userArea = $("#user_list_area");
                adminArea.empty();
                userArea.empty();

                if(!data || data.length === 0){
                    adminArea.html("<div class='p-2 text-muted'>ê´€ë¦¬ ì¤‘ì¸ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
                    userArea.html("<div class='p-2 text-muted'>ì°¸ì—¬ ì¤‘ì¸ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>");
                    return;
                }

                // ADMIN ê·¸ë£¹ ì¤‘ë³µ ì œê±°ìš© Map
                let adminGroupSet = new Map();

                $.each(data, function(index, item){
                    let role = item.role;
                    let groupName = item.groupName ? item.groupName : "ê·¸ë£¹ì—†ìŒ";
                    let workName = item.workName ? item.workName : "ì—…ë¬´ëª…ì—†ìŒ";
                    let spaceCode = item.spaceCode ? item.spaceCode : "ì½”ë“œì—†ìŒ";
                    let groupId = item.groupId;

                    if(role === 'ADMIN'){
                        // ì´ë¯¸ ë“±ë¡ëœ ê·¸ë£¹ëª…ì´ ì•„ë‹ˆë©´ ê·¸ë¦¬ê¸°
                        if(!adminGroupSet.has(groupName)){
                            adminGroupSet.set(groupName, groupId);

                            let html = `
                                <div class="card-item">
                                    <div class="item-info">
                                        <strong>${groupName}</strong>
                                        <span>ê´€ë¦¬ì ê¶Œí•œ</span>
                                    </div>
                                    <button class="btn-gray" onclick="location.href='/group/spaceList/${groupId}'">ê·¸ë£¹ ê´€ë¦¬</button>
                                </div>
                            `;
                            adminArea.append(html);
                        }

                    } else if(role === 'USER'){
                        // USERëŠ” ëª¨ë“  ì—…ë¬´ë¥¼ ë‚˜ì—´
                        let html = `
                            <div class="card-item">
                                <div class="item-info">
                                    <div style="font-size: 18px; font-weight: bold; color: #333;">
                                        ${groupName}
                                    </div>
                                    <span style="display: block; font-size: 14px; color: #888; margin-top: 4px;">
                                        ${workName}
                                    </span>
                                    <span style="display: block; font-size: 14px; color: #888; margin-top: 4px;">
                                        [ ${spaceCode} ]
                                    </span>
                                </div>
                                <button class="btn-yellow" onclick="requestHandover(${item.spaceId})">ì¸ê³„í•˜ê¸°</button>
                            </div>
                        `;
                        userArea.append(html);
                    }
                });

                if(adminArea.is(':empty')) adminArea.html("<div class='p-2 text-muted'>ê´€ë¦¬ ì¤‘ì¸ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
                if(userArea.is(':empty')) userArea.html("<div class='p-2 text-muted'>ì°¸ì—¬ ì¤‘ì¸ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>");
            },
            error: function(err){
                alert("ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    // ì¸ê³„í•˜ê¸° ë²„íŠ¼ (ì´ˆëŒ€ ê¸°ëŠ¥)
    function requestHandover(spaceId){
        let email = prompt("ì—…ë¬´ë¥¼ ì¸ê³„í•  ì‚¬ìš©ìì˜ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if(!email) return;

        $.ajax({
            url: '/api/userSpace/invite',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ spaceId: spaceId, email: email.trim() }),
            success: function() { alert("ì¸ê³„(ì´ˆëŒ€) ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."); },
            error: function(err) {
                let msg = err.responseJSON && err.responseJSON.message ? err.responseJSON.message : "ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                alert(msg);
            }
        });
    }

    // [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
    function logout() {
        if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem("accessToken"); // í† í° ì‚­ì œ
            location.href = "/user/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        }
    }
</script>

</body>
</html>